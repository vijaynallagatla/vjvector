global
    daemon
    maxconn 4096
    log stdout format raw local0 info

defaults
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    log global
    option httplog
    option dontlognull
    option http-server-close
    option forwardfor except 127.0.0.0/8
    option redispatch
    retries 3

# HAProxy stats page
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats auth admin:admin123

# VJVector API Load Balancer
frontend vjvector_api
    bind *:80
    mode http
    default_backend vjvector_backend
    option forwardfor
    option http-server-close
    
    # Health check endpoint
    acl health_check path /health
    acl health_check path /ready
    
    # Logging
    log global
    option httplog

backend vjvector_backend
    mode http
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    default-server inter 3s fall 3 rise 2
    
    # VJVector nodes
    server vjvector-master localhost:8080 check weight 100
    server vjvector-slave-1 localhost:8082 check weight 100
    server vjvector-slave-2 localhost:8084 check weight 100
    
    # Health check configuration
    option httpchk GET /health
    http-check expect status 200
    http-check expect string "healthy"
    
    # Connection settings
    maxconn 1000
    timeout connect 5s
    timeout server 30s
    
    # Sticky sessions (optional)
    cookie SERVERID insert indirect nocache
    
    # Retry configuration
    retry-on all-retryable-errors
    retries 3
